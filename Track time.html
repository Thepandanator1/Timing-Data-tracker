<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Production Time Tracker</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
.controls > * { margin: 6px 8px 6px 0; }
input[type="text"], input[type="text"].workerNumbers { padding: 6px; width: 150px; max-width: 60vw; }
table { border-collapse: collapse; margin: 14px 0; width: auto; }
th, td { border: 1px solid #aaa; padding: 6px 10px; text-align: center; }
th { background: #f3f3f3; }
button { padding: 8px 12px; cursor: pointer; }
h2.title, h2#resultsTitle { text-align: center; margin: 10px 0 6px; }
.person-block h3 { margin: 12px 0 6px; }
.hidden { display: none; }
.person-row { display: flex; align-items: center; margin-bottom: 6px; gap: 6px; }
textarea.noteInput { width: 100px; height: 20px; }
</style>
</head>
<body>
<h1>Production Time Tracker</h1>

<div class="controls">
  <label>Batch:</label>
  <input type="text" id="tableTitle" placeholder="6-12 72 Odyssey x10" />

  <h3>Workers & Assigned Batteries (comma-separated):</h3>
  <div id="nameContainer">
    <div class="person-row">
      <input type="text" placeholder="Name" class="personName">
      <input type="text" placeholder="Batteries" class="workerNumbers">
    </div>
    <div class="person-row">
      <input type="text" placeholder="Name" class="personName">
      <input type="text" placeholder="Batteries" class="workerNumbers">
    </div>
    <div class="person-row">
      <input type="text" placeholder="Name" class="personName">
      <input type="text" placeholder="Batteries" class="workerNumbers">
    </div>
  </div>
  <button id="addPersonBtn">Add Worker</button>
  <button id="removePersonBtn">Remove Worker</button>
  <button id="generateBtn" style="margin-top:10px;">Generate Table</button>
</div>

<div id="tableContainer"></div>

<div id="actionButtons" class="controls hidden">
  <button id="calculateBtn">Calculate Times</button>
  <button id="exportBtn" class="hidden">Export CSV</button>
</div>

<h2 id="resultsTitle" class="hidden">Total Times</h2>
<div id="results"></div>

<script>
const dayIndexMap = { M:0, Tu:1, W:2, Th:3, F:4, Sa:5, Su:6 };

/* ---------- TIME PARSING ---------- */
function parseTimeWithDay(input){
  const trimmed = input.trim();
  const m = trimmed.match(/^(\d{1,2})(?::(\d{1,2}))?\s*(am|pm|a|p)?\s+(M|Tu|W|Th|F|Sa|Su)$/i);
  if(!m) throw 'Time must be like "11:54 Tu" or "1:10pm Th"';
  let h = parseInt(m[1],10);
  let min = m[2] !== undefined ? parseInt(m[2],10) : 0;
  const suffix = m[3] ? m[3].toLowerCase() : null;
  const dayStr = m[4];
  const dIdx = dayIndexMap[dayStr];
  if(dIdx === undefined) throw 'Invalid day abbreviation';
  if(isNaN(h) || isNaN(min) || min<0 || min>59) throw 'Invalid time';

  if(suffix){
    if(h < 1 || h > 12) throw 'Invalid 12h time';
    if(suffix === 'am' || suffix === 'a'){
      if(h === 12) h = 0;
    }else{
      if(h !== 12) h += 12;
    }
  }else{
    if(h < 0 || h > 23) throw 'Time out of range';
    if(h >= 1 && h <= 6) h += 12; // assume PM for 1..6
  }

  return { totalMinutes: dIdx*1440 + h*60 + min, dayIndex: dIdx };
}

function parseHourMinute(input){
  input = input.trim();
  if(!input) return 0;
  const parts = input.split(':');
  let hours = parseInt(parts[0],10)||0;
  let minutes = parts[1]!==undefined ? parseInt(parts[1],10) : 0;
  if(isNaN(hours)||isNaN(minutes)||minutes<0||minutes>59) throw 'Invalid pause';
  return hours*60 + minutes;
}

function formatHoursMinutes(totalMinutes){
  const hours=Math.floor(totalMinutes/60);
  const minutes=totalMinutes%60;
  return `${hours}:${minutes.toString().padStart(2,'0')}`;
}

/* ---------- SHIFT-AWARE DURATION ---------- */
function calculateShiftDuration(startObj, endObj) {
  const shiftStart = 8 * 60;     // 8:00
  const shiftEnd = 16 * 60 + 30; // 16:30
  const shiftLength = shiftEnd - shiftStart; // 510 min

  let startDay = startObj.dayIndex;
  let endDay = endObj.dayIndex;
  let startMin = startObj.totalMinutes % 1440;
  let endMin = endObj.totalMinutes % 1440;

  let daysDiff = endDay - startDay;
  if (daysDiff < 0) daysDiff += 7; // handle Fri->Mon, etc.

  let total = 0;

  // Same-day case
  if (daysDiff === 0) {
    const s = Math.max(startMin, shiftStart);
    const e = Math.min(endMin, shiftEnd);
    return Math.max(0, e - s);
  }

  // First day
  total += Math.max(0, shiftEnd - Math.max(startMin, shiftStart));

  // Full days in between
  for (let i = 1; i < daysDiff; i++) {
    const day = (startDay + i) % 7;
    if (day <= 4) total += shiftLength; // weekdays only
  }

  // Last day
  total += Math.max(0, Math.min(endMin, shiftEnd) - shiftStart);

  return total;
}

/* ---------- CSV FIELD ESCAPING ---------- */
function csvField(val){
  const s = (val ?? '').toString();
  return `"${s.replace(/"/g, '""')}"`;
}

/* ---------- UI BUTTONS ---------- */
document.getElementById('addPersonBtn').addEventListener('click',()=>{
  const nc=document.getElementById('nameContainer');
  const idx=nc.querySelectorAll('.person-row').length+1;
  const div=document.createElement('div');
  div.className='person-row';
  div.innerHTML=`<input type="text" placeholder="Person ${idx} Name" class="personName">
                 <input type="text" placeholder="Batteries" class="workerNumbers">`;
  nc.appendChild(div);
});

document.getElementById('removePersonBtn').addEventListener('click',()=>{
  const nc=document.getElementById('nameContainer');
  const rows=nc.querySelectorAll('.person-row');
  if(rows.length>1) nc.removeChild(rows[rows.length-1]);
});

document.getElementById('generateBtn').addEventListener('click',()=>{
  generateTable();
  document.getElementById('exportBtn').classList.add('hidden');
});
document.getElementById('calculateBtn').addEventListener('click',()=>{
  calculateTimes();
  document.getElementById('exportBtn').classList.remove('hidden');
});
document.getElementById('exportBtn').addEventListener('click',exportCSV);

/* ---------- PEOPLE ---------- */
function getPeople(){
  const rows=document.querySelectorAll('.person-row');
  return Array.from(rows).map((row,idx)=>{
    const name=row.querySelector('.personName').value.trim()||row.querySelector('.personName').placeholder||`Person ${idx+1}`;
    const numbers=row.querySelector('.workerNumbers').value.trim();
    return {name,numbers};
  });
}

/* ---------- TABLE GENERATION ---------- */
function generateTable(){
  const container=document.getElementById('tableContainer');
  container.innerHTML='';
  document.getElementById('resultsTitle').classList.add('hidden');
  document.getElementById('results').innerHTML='';
  document.getElementById('actionButtons').classList.remove('hidden');

  const people=getPeople();
  const titleText=document.getElementById('tableTitle').value.trim();
  if(titleText){
    const h2=document.createElement('h2');
    h2.className='title';
    h2.textContent=titleText;
    container.appendChild(h2);
  }

  people.forEach((person,pIndex)=>{
    const block=document.createElement('div');
    block.className='person-block';
    const personTitle=document.createElement('h3');
    personTitle.textContent=`${person.name}${person.numbers? ` (Batteries: ${person.numbers})` : ''}`;
    block.appendChild(personTitle);

    const table=document.createElement('table');
    const header=document.createElement('tr');
    header.innerHTML='<th>Start</th><th>End</th><th>Lunch?</th><th>Pauses</th><th>Note</th>';
    table.appendChild(header);

    const row=document.createElement('tr');
    row.innerHTML=`
      <td><input id="p${pIndex}start" placeholder="8:00 M" /></td>
      <td><input id="p${pIndex}end" placeholder="4:30 M" /></td>
      <td><input type="checkbox" id="p${pIndex}lunch"></td>
      <td><input id="p${pIndex}break" placeholder="0:30" /></td>
      <td><input id="p${pIndex}note" class="noteInput" placeholder="" /></td>`;
    table.appendChild(row);

    block.appendChild(table);
    container.appendChild(block);
  });
}

/* ---------- CALCULATIONS ---------- */
function calculateTimes(){
  const people=getPeople();
  let resultsHTML='';
  people.forEach((person,pIndex)=>{
    let html=`<h3>${person.name}${person.numbers? ` (Batteries: ${person.numbers})` : ''}</h3>`;
    const startStr=(document.getElementById(`p${pIndex}start`)?.value||'').trim();
    const endStr=(document.getElementById(`p${pIndex}end`)?.value||'').trim();
    const breakStr=(document.getElementById(`p${pIndex}break`)?.value||'0:00').trim();
    const lunchChecked=document.getElementById(`p${pIndex}lunch`)?.checked;

    try{
      const startObj=parseTimeWithDay(startStr);
      const endObj=parseTimeWithDay(endStr);

      // Only error if same-day and end < start; allow week wrap (e.g., F -> M)
      let daysDiff = endObj.dayIndex - startObj.dayIndex;
      if (daysDiff < 0) daysDiff += 7;
      if (daysDiff === 0 && endObj.totalMinutes < startObj.totalMinutes){
        html+=`<table><tr style="color:red"><td>End before start</td></tr></table>`;
      } else {
        let duration = calculateShiftDuration(startObj, endObj);
        const breakTime=parseHourMinute(breakStr);
        duration = Math.max(0, duration - breakTime);
        if(lunchChecked) duration = Math.max(0, duration - 30);

        html+=`<table><tr><th>Total (hh:mm)</th></tr><tr><td>${formatHoursMinutes(duration)}</td></tr></table>`;
      }
    }catch(e){
      html+=`<table><tr style="color:red"><td>${e}</td></tr></table>`;
    }

    resultsHTML+=html;
  });
  document.getElementById('results').innerHTML=resultsHTML;
  document.getElementById('resultsTitle').classList.remove('hidden');
}

/* ---------- CSV EXPORT (no lunch & no pauses columns) ---------- */
function exportCSV(){
  const people=getPeople();
  let csv='';
  const titleText=document.getElementById('tableTitle').value.trim();
  if(titleText) csv += csvField(titleText) + '\n\n';

  // Header: Worker, Batteries, Start, End, Duration, Note
  csv += [
    'Worker','Batteries','Start','End','Duration (hh:mm)','Note'
  ].map(csvField).join(',') + '\n';

  people.forEach((person,pIndex)=>{
    const startStr=(document.getElementById(`p${pIndex}start`)?.value||'').trim();
    const endStr=(document.getElementById(`p${pIndex}end`)?.value||'').trim();
    const breakStr=(document.getElementById(`p${pIndex}break`)?.value||'0:00').trim();
    const lunchChecked=document.getElementById(`p${pIndex}lunch`)?.checked;
    const noteStr=(document.getElementById(`p${pIndex}note`)?.value||'').trim();

    try{
      const startObj=parseTimeWithDay(startStr);
      const endObj=parseTimeWithDay(endStr);

      // Only error if same-day and end < start
      let daysDiff = endObj.dayIndex - startObj.dayIndex;
      if (daysDiff < 0) daysDiff += 7;
      if (daysDiff === 0 && endObj.totalMinutes < startObj.totalMinutes) throw 'End before start';

      let duration = calculateShiftDuration(startObj, endObj);
      const breakTime=parseHourMinute(breakStr);
      duration = Math.max(0, duration - breakTime);
      if(lunchChecked) duration = Math.max(0, duration - 30);

      const row = [
        person.name,
        person.numbers,
        startStr,
        endStr,
        formatHoursMinutes(duration),
        noteStr
      ].map(csvField).join(',');
      csv += row + '\n';
    } catch(e){
      const row = [
        person.name,
        person.numbers,
        startStr,
        endStr,
        'ERROR',
        e
      ].map(csvField).join(',');
      csv += row + '\n';
    }
  });

  const blob=new Blob([csv],{type:'text/csv'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  const filename = titleText
    ? `${titleText.replace(/[^a-z0-9_\- ]/gi,'')}.csv`
    : 'time_tracking.csv';
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
}
</script>
</body>
</html>
