<!DOCTYPE html>
<html>
<head>
  <title>Multi-Person Product Time Tracker</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input { width: 80px; margin-right: 5px; }
    table { border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #aaa; padding: 5px 10px; text-align: center; }
    button { margin: 5px; }
  </style>
</head>
<body>
  <h1>Multi-Person Product Time Tracker</h1>

  <label for="people">Number of People:</label>
  <input type="number" id="people" value="2" min="1">
  <label for="steps">Number of Steps:</label>
  <input type="number" id="steps" value="4" min="1">
  <button id="generateBtn">Generate Table</button>

  <div id="tableContainer"></div>
  <button id="calculateBtn">Calculate Times</button>
  <button id="exportBtn">Export CSV</button>

  <h2>Results</h2>
  <div id="results"></div>

  <script>
    const WORKDAY_START = 8 * 60;   // 8:00 AM
    const WORKDAY_END = 18 * 60;    // 6:00 PM

    function generateTable() {
      const container = document.getElementById('tableContainer');
      container.innerHTML = '';
      const people = parseInt(document.getElementById('people').value);
      const steps = parseInt(document.getElementById('steps').value);
      if (!people || !steps || people < 1 || steps < 1) { alert('Enter valid numbers'); return; }

      for (let p = 1; p <= people; p++) {
        const title = document.createElement('h3');
        title.textContent = `Person ${p}`;
        container.appendChild(title);

        const table = document.createElement('table');
        const header = document.createElement('tr');
        header.innerHTML = '<th>Step</th><th>Start</th><th>End</th><th>Break (min)</th>';
        table.appendChild(header);

        for (let s = 1; s <= steps; s++) {
          const row = document.createElement('tr');
          row.innerHTML = `<td>Step ${s}</td>
            <td><input id="p${p}s${s}start" placeholder="8:00"></td>
            <td><input id="p${p}s${s}end" placeholder="10:00"></td>
            <td><input id="p${p}s${s}break" placeholder="0"></td>`;
          table.appendChild(row);
        }
        container.appendChild(table);
      }
    }

    function parseTime(str) {
      str = str.trim();
      if (!str) throw 'Time required';
      const parts = str.split(':');
      let hours = parseInt(parts[0]);
      let minutes = parts[1] ? parseInt(parts[1]) : 0;
      if (isNaN(hours) || isNaN(minutes)) throw 'Invalid time';
      if (hours < 8) hours += 12;  
      const totalMinutes = hours*60 + minutes;
      if (totalMinutes < WORKDAY_START) throw 'Time before workday start';
      if (totalMinutes > WORKDAY_END) throw 'Time after workday end';
      return totalMinutes;
    }

    function calculateTimes() {
      const people = parseInt(document.getElementById('people').value);
      const steps = parseInt(document.getElementById('steps').value);
      let resultsHTML = '';

      for (let p = 1; p <= people; p++) {
        let totalMinutes = 0;
        let html = `<h3>Person ${p}</h3><table><tr><th>Step</th><th>Duration (hours)</th></tr>`;
        for (let s = 1; s <= steps; s++) {
          try {
            const startStr = document.getElementById(`p${p}s${s}start`).value || '';
            const endStr = document.getElementById(`p${p}s${s}end`).value || '';
            const breakStr = document.getElementById(`p${p}s${s}break`).value || '0';

            let start = parseTime(startStr);
            let end = parseTime(endStr);
            if (end < start) throw 'End time cannot be before start time';
            const breakTime = parseInt(breakStr) || 0;

            const durationHours = Math.max(0, (end - start - breakTime)/60).toFixed(2);
            totalMinutes += (end - start - breakTime);
            html += `<tr><td>Step ${s}</td><td>${durationHours}</td></tr>`;
          } catch(e) {
            html += `<tr><td>Step ${s}</td><td style="color:red;">${e}</td></tr>`;
          }
        }
        const totalHours = (totalMinutes/60).toFixed(2);
        html += `<tr><td><b>Total (hours)</b></td><td><b>${totalHours}</b></td></tr></table>`;
        resultsHTML += html;
      }

      document.getElementById('results').innerHTML = resultsHTML;
    }

    function exportCSV() {
      const people = parseInt(document.getElementById('people').value);
      const steps = parseInt(document.getElementById('steps').value);
      let csv = 'Person,Step,Start,End,Break (min),Duration (hours)\n';

      for (let p = 1; p <= people; p++) {
        let totalMinutes = 0;
        for (let s = 1; s <= steps; s++) {
          try {
            const startStr = document.getElementById(`p${p}s${s}start`).value || '';
            const endStr = document.getElementById(`p${p}s${s}end`).value || '';
            const breakStr = document.getElementById(`p${p}s${s}break`).value || '0';

            let start = parseTime(startStr);
            let end = parseTime(endStr);
            if (end < start) throw 'End before start';
            const breakTime = parseInt(breakStr) || 0;
            const durationHours = Math.max(0, (end - start - breakTime)/60).toFixed(2);
            totalMinutes += (end - start - breakTime);

            csv += `Person ${p},Step ${s},${startStr},${endStr},${breakStr},${durationHours}\n`;
          } catch(e) {
            csv += `Person ${p},Step ${s},ERROR,ERROR,0,0\n`;
          }
        }
        const totalHours = (totalMinutes/60).toFixed(2);
        csv += `Person ${p},Total,,, ,${totalHours}\n`;
      }

      const blob = new Blob([csv], {type:'text/csv'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'time_tracking.csv';
      link.click();
    }

    document.getElementById('generateBtn').addEventListener('click', generateTable);
    document.getElementById('calculateBtn').addEventListener('click', calculateTimes);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
  </script>
</body>
</html>
